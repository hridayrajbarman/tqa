<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MASTER ADMIN | TECH QA</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-white p-6 md:p-12 font-sans">
    <header class="flex justify-between items-end border-b border-zinc-900 pb-10 mb-12">
        <h1 class="text-3xl font-black tracking-tighter text-blue-500 italic uppercase">System Control</h1>
        <div id="status" class="text-[9px] font-black px-4 py-1 rounded-full border border-zinc-800 italic">Syncing...</div>
    </header>

    <div class="grid lg:grid-cols-3 gap-10">
        <div class="bg-zinc-900/50 p-8 rounded-[2.5rem] border border-zinc-800 h-fit">
            <h2 class="text-xl font-bold mb-8 text-green-500 italic uppercase tracking-widest">Push Balance</h2>
            <div class="space-y-4">
                <input id="target-user" type="text" placeholder="Username" class="w-full bg-black p-4 rounded-2xl border border-zinc-800 outline-none">
                <input id="add-amt" type="number" placeholder="Amount" class="w-full bg-black p-4 rounded-2xl border border-zinc-800 outline-none">
                <button onclick="updateBalance()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase text-xs italic tracking-[0.3em]">Submit</button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-zinc-900/50 p-8 rounded-[2.5rem] border border-zinc-800 shadow-2xl">
            <h2 class="text-xl font-bold mb-8 text-indigo-400 italic text-center uppercase tracking-[0.3em]">User Access Center</h2>
            <div id="user-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBMUzq53tvH-ntEJsfRj08ReeGMSd_RmrY",
            databaseURL: "https://techqaportal-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "techqaportal"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            const data = snap.val();
            if(data) Object.keys(data).forEach(username => {
                const u = data[username];
                const d = u.depositDetails || { acc: "", upi: "" };
                list.innerHTML += `
                <div class="bg-black p-6 rounded-[2.5rem] border border-zinc-800">
                    <p class="font-black italic text-center uppercase mb-1 text-blue-500">${u.name}</p>
                    <p class="text-[9px] text-zinc-600 font-bold uppercase text-center mb-4 italic">Bal: â‚¹${u.balance || 0}</p>
                    
                    <div class="space-y-2 mb-4 bg-zinc-900 p-4 rounded-2xl">
                        <input id="acc-${username}" value="${d.acc}" placeholder="User Bank Acc" class="w-full bg-black text-[9px] p-2 rounded border border-zinc-800 outline-none">
                        <input id="upi-${username}" value="${d.upi}" placeholder="User UPI ID" class="w-full bg-black text-[9px] p-2 rounded border border-zinc-800 outline-none">
                        <button onclick="savePayment('${username}')" class="w-full bg-zinc-800 py-2 rounded text-[8px] font-black uppercase hover:bg-zinc-700">Set Deposit Info</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-zinc-900">
                        <div class="grid grid-cols-2 gap-1">
                             <button onclick="toggleT('${username}', 9, ${u.permissions?.task9})" class="p-1 rounded text-[7px] font-black ${u.permissions?.task9 ? 'bg-green-600' : 'bg-zinc-800'}">T9</button>
                             <button onclick="toggleT('${username}', 11, ${u.permissions?.task11})" class="p-1 rounded text-[7px] font-black ${u.permissions?.task11 ? 'bg-green-600' : 'bg-zinc-800'}">T11</button>
                             <button onclick="toggleT('${username}', 16, ${u.permissions?.task16})" class="p-1 rounded text-[7px] font-black ${u.permissions?.task16 ? 'bg-green-600' : 'bg-zinc-800'}">T16</button>
                             <button onclick="toggleT('${username}', 21, ${u.permissions?.task21})" class="p-1 rounded text-[7px] font-black ${u.permissions?.task21 ? 'bg-green-600' : 'bg-zinc-800'}">T21</button>
                        </div>
                        <button onclick="resetBal('${username}')" class="p-1 rounded text-[7px] font-black uppercase bg-red-900/30 text-red-500">Reset 0</button>
                    </div>
                </div>`;
            });
        });

        window.savePayment = async (username) => {
            const acc = document.getElementById('acc-' + username).value;
            const upi = document.getElementById('upi-' + username).value;
            await update(ref(db, 'users/' + username + '/depositDetails'), { acc, upi });
            alert("Deposit settings saved for " + username);
        };

        window.resetBal = async (username) => {
            if(confirm("Confirm balance reset to 0 for " + username + "?")) {
                await update(ref(db, 'users/' + username), { balance: 0 });
                alert("Zeroed.");
            }
        };

        window.updateBalance = async () => {
            const user = document.getElementById('target-user').value.trim();
            const amt = parseFloat(document.getElementById('add-amt').value);
            const snap = await get(ref(db, 'users/' + user));
            if(snap.exists()){
                const current = snap.val().balance || 0;
                await update(ref(db, 'users/' + user), { balance: current + amt });
                alert("Balance Updated!");
            } else { alert("User not found!"); }
        };

        window.toggleT = async (user, id, current) => {
            await update(ref(db, 'users/' + user + '/permissions'), { ['task' + id]: !current });
        };
    </script>
</body>
</html>

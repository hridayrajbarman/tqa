<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECH QA | PROFESSIONAL PORTAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .tab-content { display: none; }
        .active { display: block; }
        .blur-text { filter: blur(8px); user-select: none; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans">

    <div id="main-app" class="hidden min-h-screen">
        <header class="p-5 glass sticky top-0 z-50 flex justify-between items-center border-b border-slate-800">
            <span class="text-xl font-black text-blue-500 italic uppercase">Tech QA</span>
            <button onclick="logout()" class="text-[10px] bg-red-900/20 text-red-500 px-3 py-1 rounded-full font-black uppercase">Logout</button>
        </header>

        <main class="p-4 space-y-6">
            <div class="bg-gradient-to-br from-slate-900 to-indigo-950 p-6 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <p class="text-[10px] uppercase font-black tracking-widest opacity-60">Available Funds</p>
                        <h2 class="text-4xl font-black italic">₹<span id="balance">0</span></h2>
                    </div>
                    <div class="text-right">
                        <p id="user-display" class="text-[10px] font-black uppercase text-blue-400">---</p>
                        <p id="header-id" class="text-[8px] font-mono text-slate-500">ID: ---</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="showDepositModal()" class="bg-green-600/10 text-green-500 py-3 rounded-2xl text-[9px] font-black uppercase border border-green-500/20">Deposit</button>
                    <button onclick="showWithdrawModal()" class="bg-orange-600/10 text-orange-500 py-3 rounded-2xl text-[9px] font-black uppercase border border-orange-500/20">Withdraw</button>
                    <button onclick="showTab('transaction')" class="bg-blue-600/10 text-blue-500 py-3 rounded-2xl text-[9px] font-black uppercase border border-blue-500/20">History</button>
                </div>
            </div>

            <section id="home" class="tab-content active space-y-4">
                <div id="task-container" class="space-y-4"></div>
            </section>

            <section id="transaction" class="tab-content hidden space-y-6">
                <div class="bg-slate-900/50 p-6 rounded-[2rem] border border-slate-800">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Transaction Logs</h3>
                    <div id="history-list" class="space-y-2 text-[10px] italic text-slate-600">No activity recorded.</div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 border border-slate-800 shadow-2xl" id="modal-content"></div>
    </div>

    <script type="module">
        // Import initialization remains same
        
        // DYNAMIC DEPOSIT MODAL WITH NEW FIELDS
        window.showDepositModal = async () => {
            const snap = await get(child(ref(db), `users/${window.currentUser.username}/depositDetails`));
            const d = snap.exists() ? snap.val() : {};
            
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-black mb-6 text-green-500 uppercase italic text-center tracking-widest">Manual Deposit</h2>
                <div class="space-y-2 bg-slate-950 p-4 rounded-2xl border border-slate-800 text-[10px] font-bold uppercase">
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>Bank:</span> <span>${d.bankName || '---'}</span></p>
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>Name:</span> <span>${d.accName || '---'}</span></p>
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>A/C No:</span> <span>${d.accNo || '---'}</span></p>
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>IFSC:</span> <span>${d.ifsc || '---'}</span></p>
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>Branch:</span> <span>${d.branch || '---'}</span></p>
                    <p class="flex justify-between border-b border-slate-900 pb-1"><span>UPI:</span> <span class="text-blue-400">${d.upi || '---'}</span></p>
                    <p class="text-yellow-500 text-center mt-3 italic leading-tight">For QR payment, please contact the receptionist or your manager.</p>
                </div>
                <button onclick="closeModal()" class="w-full mt-6 text-slate-500 text-[10px] font-black uppercase">Dismiss</button>`;
        };

        // WITHDRAWAL WITH 10 SEC TIMER
        window.showWithdrawModal = () => {
            const amt = window.currentUser.balance;
            if(amt <= 0) return alert("Insufficient funds.");
            
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-black mb-4 text-orange-500 uppercase text-center">Withdraw All</h2>
                <div class="space-y-3">
                    <p class="text-center text-white font-black text-lg italic">₹${amt}</p>
                    <input id="w-bank" placeholder="Bank Name" class="w-full p-3 bg-slate-950 rounded-xl border border-slate-800 text-xs">
                    <input id="w-acc" placeholder="Account Number" class="w-full p-3 bg-slate-950 rounded-xl border border-slate-800 text-xs">
                    <input id="w-ifsc" placeholder="IFSC Code" class="w-full p-3 bg-slate-950 rounded-xl border border-slate-800 text-xs">
                    <div id="timer-box" class="hidden text-center text-red-500 text-[10px] font-black animate-pulse">REMOVING BALANCE IN 10s...</div>
                    <button id="withdraw-btn" onclick="submitFullWithdraw(${amt})" class="w-full bg-orange-600 py-4 rounded-2xl font-black mt-4 uppercase text-[10px]">Send Request</button>
                </div>`;
        };

        window.submitFullWithdraw = async (amt) => {
            const b = document.getElementById('w-bank').value;
            const a = document.getElementById('w-acc').value;
            const i = document.getElementById('w-ifsc').value;
            
            if(!b || !a || !i) return alert("Fill all fields.");

            // 1. Send request to admin
            await push(ref(db, 'withdrawals'), {
                user: window.currentUser.username,
                bank: b, acc: a, ifsc: i,
                amount: amt,
                timestamp: Date.now()
            });

            document.getElementById('withdraw-btn').classList.add('hidden');
            document.getElementById('timer-box').classList.remove('hidden');

            // 2. Safety Timer: Deduct after 10 seconds
            setTimeout(async () => {
                await update(ref(db, `users/${window.currentUser.username}`), { balance: 0 });
                alert("Request Finalized. Balance Deducted.");
                closeModal();
            }, 10000);
        };
        // closeModal and navigation logic remains same
    </script>
</body>
</html>
